<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KARAAGE EATER</title>
    <style>
        html, body { position: fixed; width: 100%; height: 100%; overflow: hidden; touch-action: none; }
        body { 
            margin: 0; padding: 0; text-align: center; 
            background-color: #d2b48c;
            background-image: linear-gradient(45deg, #deb887 25%, transparent 25%, transparent 75%, #deb887 75%, #deb887), linear-gradient(45deg, #deb887 25%, transparent 25%, transparent 75%, #deb887 75%, #deb887);
            background-size: 60px 60px; background-position: 0 0, 30px 30px;
            font-family: 'Arial Black', sans-serif;
        }
        #header { width: 100%; height: 50px; background: #222; color: #fff; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; z-index: 100; font-size: 20px; }
        #info-bar { position: fixed; top: 55px; width: 100%; z-index: 100; display: flex; justify-content: space-around; font-size: 16px; color: #5d4037; font-weight: bold; background: rgba(255,255,255,0.4); border-radius: 5px; }
        #char { font-size: 60px; position: absolute; z-index: 10; transform: translate(-50%, -50%); pointer-events: none; display: none; }
        .food { font-size: 45px; position: absolute; transform: translate(-50%, -50%); display: none; }
        .water { font-size: 45px; position: absolute; transform: translate(-50%, -50%); z-index: 5; display: none; }
        #joystick-area { position: fixed; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(0,0,0,0.2); border-radius: 50%; z-index: 200; display: none; }
        #joystick-stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: #333; border-radius: 50%; transform: translate(-50%, -50%); }
        #action-btn-area { position: fixed; bottom: 35px; right: 25px; z-index: 200; display: none; }
        #btn { width: 110px; height: 110px; color: white; border-radius: 50%; border: 5px solid #fff; font-size: 18px; font-weight: bold; box-shadow: 0 6px rgba(0,0,0,0.3); transition: background-color 0.2s, transform 0.1s; }
        .btn-eat { background: #D2691E; }
        .btn-drink { background: #1E90FF; }
        #btn:active { transform: scale(0.9); }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.88); z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .game-logo { font-size: 42px; color: #FFD700; text-shadow: 4px 4px 0px #D2691E; margin-bottom: 20px; cursor: pointer; }
        .menu-title { font-size: 24px; color: #fff; margin-top: 10px; margin-bottom: 10px; border-bottom: 2px solid #fff; padding-bottom: 5px; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠãƒœã‚¿ãƒ³ã®é…è‰²ä¿®æ­£ */
        .level-btn { width: 240px; padding: 14px; margin: 8px; font-size: 22px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 5px rgba(0,0,0,0.4); }
        .lv-komori { background: #4CAF50; color: #fff; border: 2px solid #2e7d32; }
        .lv-namimori { background: #FFC107; color: #333; border: 2px solid #ffa000; } /* é»’æ–‡å­— */
        .lv-oomori { background: #FF5722; color: #fff; border: 2px solid #d84315; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); } /* å½±ã‚’è¿½åŠ  */
        .lv-tokumori { background: #9C27B0; color: #fff; border: 2px solid #6a1b9a; display: none; }
        .lv-bonus { background: #E91E63; color: #fff; border: 2px solid #ad1457; display: none; }
        
        #ready-count { font-size: 140px; color: #FF4500; text-shadow: 5px 5px 0px #fff; }
        #hint-text { font-size: 20px; color: #FFD700; margin-bottom: 30px; min-height: 2.5em; width: 85%; line-height: 1.4; }
    </style>
</head>
<body>
    <div id="header">KARAAGE EATER</div>
    <div id="info-bar">
        <div id="timer-ui">TIME: 30</div>
        <div id="count-ui">EAT: 0</div>
    </div>
    <div id="karaage" class="food">ğŸ—</div>
    <div id="spicy" class="food">ğŸŒ¶ï¸</div>
    <div id="big-karaage" class="food">ğŸ–</div>
    <div id="clock-item" class="food">â°</div>
    <div id="w1" class="water">ğŸ¥›</div><div id="w2" class="water">ğŸ¥›</div>
    <div id="w3" class="water">ğŸ¥›</div><div id="w4" class="water">ğŸ¥›</div>
    <div id="char">ğŸ˜</div>
    <div id="joystick-area"><div id="joystick-stick"></div></div>
    <div id="action-btn-area"><button id="btn" class="btn-eat">é£Ÿã¹ã‚‹ï¼</button></div>
    <div id="overlay">
        <div class="game-logo" onclick="debugUnlock()">KARAAGE EATER</div>
        <div id="menu-title-ui" class="menu-title">ã”æ³¨æ–‡</div>
        <div id="hint-text"></div>
        <div id="ready-count" style="display:none">5</div>
        <div id="menu-list" style="display: flex; flex-direction: column; align-items: center;">
            <button class="level-btn lv-komori" onclick="selectLevel('å°ç››')">å°ç›› (10å€‹)</button>
            <button class="level-btn lv-namimori" onclick="selectLevel('ä¸¦ç››')">ä¸¦ç›› (12å€‹)</button>
            <button class="level-btn lv-oomori" onclick="selectLevel('å¤§ç››')">å¤§ç›› (15å€‹)</button>
            <button id="tokumori-btn" class="level-btn lv-tokumori" onclick="selectLevel('ç‰¹ç››')">ç‰¹ç›› (20å€‹)</button>
            <button id="bonus-btn" class="level-btn lv-bonus" onclick="selectLevel('é£Ÿã¹æ”¾é¡Œ')">é£Ÿã¹æ”¾é¡Œ (ç„¡é™)</button>
        </div>
        <div id="finish-options" style="display:none; flex-direction:column; align-items:center;">
            <button id="quick-retry-btn" class="level-btn" style="background:#ff4500; color:white;" onclick="selectLevel(currentLevel)">å†æ³¨æ–‡ï¼ˆRETRYï¼‰</button>
            <button class="level-btn" style="background:#555; color:white;" onclick="showMenu()">ã”æ³¨æ–‡ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        /* (ä¸­ç•¥ï¼šJavaScriptãƒ­ã‚¸ãƒƒã‚¯ã¯æœ€æ–°ã®ã‚‚ã®ã‚’ç¶­æŒ) */
        let fullness = 0, targetFullness = 10, timeLeft = 30;
        let gameState = "MENU", currentLevel = "";
        let pX, pY, kX = 0, kY = 0, sx, sy, bx, by, cx, cy;
        let lastKX = 0, lastKY = 0; 
        let joyX = 0, joyY = 0, isMoving = false, isStunned = false;
        let timerId = null, bigTapCount = 0, tokumoriUnlocked = false, bonusUnlocked = false;
        let spicyChance = 0, spicyLeft = 0, bigLeft = 0, clockUsed = false;
        let chokeMeter = 0, isChoking = false;
        let debugTapCount = 0;

        const char = document.getElementById('char');
        const items = { k: document.getElementById('karaage'), s: document.getElementById('spicy'), b: document.getElementById('big-karaage'), c: document.getElementById('clock-item') };
        const waters = [document.getElementById('w1'), document.getElementById('w2'), document.getElementById('w3'), document.getElementById('w4')];
        const ui = { timer: document.getElementById('timer-ui'), count: document.getElementById('count-ui'), overlay: document.getElementById('overlay'), hint: document.getElementById('hint-text'), menuTitle: document.getElementById('menu-title-ui'), countDisp: document.getElementById('ready-count'), menuList: document.getElementById('menu-list'), finishOptions: document.getElementById('finish-options'), tokumori: document.getElementById('tokumori-btn'), bonus: document.getElementById('bonus-btn') };
        const mainBtn = document.getElementById('btn');

        function debugUnlock() {
            debugTapCount++;
            if (debugTapCount >= 5) {
                tokumoriUnlocked = true; bonusUnlocked = true;
                ui.tokumori.style.display = "block"; ui.bonus.style.display = "block";
                ui.hint.innerText = "ãƒ‡ãƒãƒƒã‚°ï¼šå…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼è§£æ”¾ï¼"; debugTapCount = 0;
            }
        }

        function showMenu() {
            gameState = "MENU"; ui.overlay.style.display = "flex"; ui.menuTitle.innerText = "ã”æ³¨æ–‡";
            ui.menuList.style.display = "flex"; ui.hint.innerText = ""; ui.countDisp.style.display = "none";
            ui.finishOptions.style.display = "none";
            if(tokumoriUnlocked) ui.tokumori.style.display = "block";
            if(bonusUnlocked) ui.bonus.style.display = "block";
        }

        function selectLevel(lv) {
            currentLevel = lv; ui.menuList.style.display = "none"; ui.finishOptions.style.display = "none";
            ui.menuTitle.innerText = lv;
            const hints = { 'å°ç››':'å®Œé£Ÿã‚’ç›®æŒ‡ãã†ï¼','ä¸¦ç››':'å”è¾›å­ã«æ³¨æ„ï¼','å¤§ç››':'è‚‰åšã¯é€£æ‰“ã ï¼','ç‰¹ç››':'æ™‚è¨ˆã‚’é€ƒã™ãªï¼','é£Ÿã¹æ”¾é¡Œ':'æ€¥ãã™ãã‚‹ã¨å–‰ãŒè©°ã¾ã‚‹ãï¼' };
            ui.hint.innerText = hints[lv];
            ui.countDisp.style.display = "block";
            let c = 5; ui.countDisp.innerText = c;
            let ci = setInterval(() => { c--; ui.countDisp.innerText = c; if(c <= 0) { clearInterval(ci); startGame(lv); } }, 1000);
        }

        function startGame(lv) {
            fullness = 0; timeLeft = 30; isStunned = false; isChoking = false; chokeMeter = 0; clockUsed = false;
            pX = window.innerWidth / 2; pY = window.innerHeight / 2;
            lastKX = 0; lastKY = 0; 
            updateBtnState("eat");
            if(lv==='å°ç››'){ targetFullness=10; spicyChance=0; bigLeft=0; }
            else if(lv==='ä¸¦ç››'){ targetFullness=12; spicyChance=3; bigLeft=0; }
            else if(lv==='å¤§ç››'){ targetFullness=15; spicyChance=5; bigLeft=2; }
            else if(lv==='ç‰¹ç››'){ targetFullness=20; spicyChance=5; bigLeft=3; }
            else if(lv==='é£Ÿã¹æ”¾é¡Œ'){ targetFullness=999; spicyChance=0; bigLeft=0; }
            spicyLeft = spicyChance;
            ui.count.innerText = lv==='é£Ÿã¹æ”¾é¡Œ' ? `EAT: 0` : `EAT: 0/${targetFullness}`;
            ui.overlay.style.display = "none"; char.style.display = "block"; char.innerText = "ğŸ˜";
            spawnWaters();
            document.getElementById('joystick-area').style.display = "block";
            document.getElementById('action-btn-area').style.display = "block";
            spawnFood(); gameState = "PLAYING"; startTimer();
        }

        function spawnWaters() {
            waters.forEach((w, i) => {
                if(currentLevel === 'é£Ÿã¹æ”¾é¡Œ') {
                    const pos = [[50,120], [window.innerWidth-50, 120], [50, window.innerHeight-160], [window.innerWidth-50, window.innerHeight-160]];
                    w.style.left = pos[i][0]+"px"; w.style.top = pos[i][1]+"px"; w.style.display = "block";
                } else { w.style.display = "none"; }
            });
        }

        function getSafePos(existingPoints = [], farFromPoint = null) {
            let x, y, tooClose, attempts = 0;
            const minDistItems = 100;
            const minDistLast = 150; 
            do {
                tooClose = false;
                x = Math.random() * (window.innerWidth - 100) + 50;
                y = Math.random() * (window.innerHeight - 350) + 150;
                for (let p of existingPoints) { if (Math.hypot(x - p.x, y - p.y) < minDistItems) tooClose = true; }
                if (farFromPoint && Math.hypot(x - farFromPoint.x, y - farFromPoint.y) < minDistLast) tooClose = true;
                attempts++;
            } while (tooClose && attempts < 50);
            return { x, y };
        }

        function spawnFood() {
            Object.values(items).forEach(i => i.style.display = "none");
            let posLog = [];
            if(spicyLeft > 0 && Math.random() < 0.45) {
                let p = getSafePos([], null); sx=p.x; sy=p.y;
                items.s.style.left = sx+"px"; items.s.style.top = sy+"px"; items.s.style.display = "block";
                spicyLeft--; posLog.push({x:sx, y:sy});
            }
            let bigAppears = (bigLeft > 0 && fullness >= 3 && Math.random() < 0.35);
            let fp = getSafePos(posLog, {x: lastKX, y: lastKY});
            if(bigAppears) { bx=fp.x; by=fp.y; items.b.style.left = bx+"px"; items.b.style.top = by+"px"; items.b.style.display = "block"; bigTapCount = 5; }
            else { kX=fp.x; kY=fp.y; items.k.style.left = kX+"px"; items.k.style.top = kY+"px"; items.k.style.display = "block"; }
        }

        function updateBtnState(type) {
            if(type === "drink") { mainBtn.innerText = "é£²ã‚€ï¼"; mainBtn.className = "btn-drink"; }
            else { mainBtn.innerText = "é£Ÿã¹ã‚‹ï¼"; mainBtn.className = "btn-eat"; }
        }

        const joyArea = document.getElementById('joystick-area');
        const stick = document.getElementById('joystick-stick');
        joyArea.addEventListener('touchstart', () => { isMoving = true; });
        joyArea.addEventListener('touchmove', (e) => {
            const t = e.touches[0]; const r = joyArea.getBoundingClientRect();
            const dx = t.clientX - (r.left + 60), dy = t.clientY - (r.top + 60);
            const dist = Math.min(Math.hypot(dx, dy), 50); const ang = Math.atan2(dy, dx);
            joyX = Math.cos(ang)*dist/50; joyY = Math.sin(ang)*dist/50;
            stick.style.left = (50+joyX*40)+"%"; stick.style.top = (50+joyY*40)+"%";
        });
        window.addEventListener('touchend', () => { isMoving = false; joyX = 0; joyY = 0; stick.style.left = "50%"; stick.style.top = "50%"; });

        function startTimer() {
            if(timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                if(gameState !== "PLAYING") return;
                timeLeft--;
                if(currentLevel === "ç‰¹ç››" && timeLeft === 15 && !clockUsed) {
                    let cp = getSafePos([{x: kX, y: kY}], null); cx = cp.x; cy = cp.y;
                    items.c.style.left = cx+"px"; items.c.style.top = cy+"px"; items.c.style.display = "block";
                    setTimeout(() => { items.c.style.display = "none"; }, 5000);
                }
                ui.timer.innerText = `TIME: ${timeLeft}`;
                if(timeLeft <= 0) endGame(currentLevel==='é£Ÿã¹æ”¾é¡Œ');
            }, 1000);
        }

        function endGame(isWin) {
            gameState = "FINISH"; clearInterval(timerId);
            ui.overlay.style.display = "flex"; ui.countDisp.style.display = "none"; ui.finishOptions.style.display = "flex";
            if(currentLevel === 'é£Ÿã¹æ”¾é¡Œ') {
                ui.menuTitle.innerText = "çµæœç™ºè¡¨";
                let title = "";
                if(fullness <= 10) title = "ã€ã²ã‚ˆã£ã“é£Ÿã„ã€‘<br>ã¾ã ã¾ã èƒƒè¢‹ã«ä½™è£•ãŒã‚ã‚‹ãªï¼";
                else if(fullness <= 20) title = "ã€ãªã‹ãªã‹ã®é£Ÿæ¼¢ã€‘<br>ã„ã„é£Ÿã¹ã£ã·ã‚Šã ã€è¦‹ç›´ã—ãŸãœï¼";
                else if(fullness <= 30) title = "ã€ãƒ—ãƒ­ç´šã®èƒƒè¢‹ã€‘<br>ã‚ã‚“ãŸã€ã‚‚ã—ã‹ã—ã¦ãƒ•ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼ã‹ï¼Ÿ";
                else title = "ã€ä¼èª¬ã®å”æšã’ç¥ã€‘<br>æã‚ã—ã„èƒƒè¢‹ã â€¦ã‚‚ã†é£Ÿã†ã‚‚ã‚“ãŒã­ãˆã‚ˆï¼";
                ui.hint.innerHTML = `è¨˜éŒ²ï¼š${fullness}å€‹<br>${title}`;
            } else if(isWin) {
                ui.menuTitle.innerText = "CLEAR!";
                ui.hint.innerText = `${currentLevel} å®Œé£Ÿï¼ãŠè¦‹äº‹ï¼`;
                if(currentLevel === "å¤§ç››") tokumoriUnlocked = true;
                if(currentLevel === "ç‰¹ç››") bonusUnlocked = true;
            } else { ui.menuTitle.innerText = "GAME OVER"; ui.hint.innerText = "æ™‚é–“åˆ‡ã‚Œã ï¼"; }
        }

        function gameLoop() {
            if (gameState === "PLAYING" && isMoving && !isStunned) {
                pX += joyX * 6; pY += joyY * 6;
                pX = Math.max(30, Math.min(window.innerWidth - 30, pX));
                pY = Math.max(100, Math.min(window.innerHeight - 150, pY));
            }
            char.style.left = pX + "px"; char.style.top = pY + "px";
            requestAnimationFrame(gameLoop);
        }
        gameLoop();

        mainBtn.onclick = () => {
            if(gameState !== "PLAYING" || isStunned) return;
            if(isChoking) {
                let drank = false;
                waters.forEach(w => { if(w.style.display !== "none" && Math.hypot(pX - parseFloat(w.style.left), pY - parseFloat(w.style.top)) < 75) { w.style.display = "none"; drank = true; } });
                if(drank) { isChoking = false; chokeMeter = 0; char.innerText = "ğŸ˜"; updateBtnState("eat"); spawnFood(); }
                return;
            }
            if(items.c.style.display === "block" && Math.hypot(pX-cx, pY-cy) < 75) { timeLeft += 7; items.c.style.display = "none"; clockUsed = true; return; }
            if(items.s.style.display === "block" && Math.hypot(pX-sx, pY-sy) < 75) {
                isStunned = true; char.innerText = "ğŸ˜­"; items.s.style.display = "none";
                setTimeout(() => { if(gameState==="PLAYING") { isStunned = false; char.innerText = "ğŸ˜"; } }, 3000); return;
            }
            let ate = false;
            if(items.b.style.display === "block" && Math.hypot(pX-bx, pY-by) < 85) {
                bigTapCount--; char.innerText = "ğŸ˜²";
                if(bigTapCount <= 0) { lastKX = bx; lastKY = by; fullness++; bigLeft--; items.b.style.display = "none"; ate = true; }
            } else if(items.k.style.display === "block" && Math.hypot(pX-kX, pY-kY) < 85) {
                lastKX = kX; lastKY = kY; fullness++; char.innerText = "ğŸ˜‹"; items.k.style.display = "none"; ate = true;
            }
            if(ate) {
                if(currentLevel === 'é£Ÿã¹æ”¾é¡Œ') {
                    chokeMeter++;
                    if(chokeMeter >= 5) { isChoking = true; char.innerText = "ğŸ¤¢"; updateBtnState("drink"); spawnWaters(); }
                    ui.count.innerText = `EAT: ${fullness}`;
                } else {
                    ui.count.innerText = `EAT: ${fullness}/${targetFullness}`;
                    if(fullness >= targetFullness) { endGame(true); return; }
                }
                setTimeout(() => { if(gameState==="PLAYING" && !isChoking) { char.innerText="ğŸ˜"; spawnFood(); } }, 200);
            }
        };
    </script>
</body>
</html>